---
layout: post
title: Is JavaScript Call-by-reference?
excerpt: JavaScript は値呼びです．
tags: javascript programming-language-systems
author: sano
category: programming-language-systems
---

JavaScript は値呼びです．

というか，現代的な言語は（参照呼びではなく）全部値呼びだと思って良いと思う[^1]．

よく，「オブジェクトは参照呼びです」とか言うけど，厳密にはそうではない．

# あれ？と思う瞬間

昔の日記：

> javascript が
>
> ```javascript
> let x = [1, 2, 3];
> ((y) => y)(x) === x;
> ```
>
> で true を返して，困惑している．
>
> 「値渡し（≒ 複製して渡す）」かつ shallow copy であるという認識だった．
>
> なので，Array オブジェクトの根本は複製されて，別のオブジェクトになるものだと思っていた．
>
> ところが，そうではない？
> （比較演算子の挙動が掴みきれてないかも．
> これはオブジェクトに関しては，物理比較であっているのかな？）
>
> > 追記：物理比較で，あってる．
>
> もしかして，python と同じような戦略なのかな？
>
> > 追記：python と同じ戦略で，あってる．

# 答え：オブジェクトへの参照を複製して渡している

`((y) => y)` は，引数にとったオブジェクトへの参照を，
複製して，返している．

複製しているわけだけど，値としては等しいので，元の値と比較したら真になる．

だから，上記のコードは（当然） `true` を返す．

# 本当に値呼び？代入しちゃえ

値呼びでは，
引数として参照を渡したとしても，
参照を **複製して** 関数の引数に渡している（と考えるのが自然だろう）．

仮引数に直接代入したところで，
元の値自体は変更できない（複製されているし）．

例えばこう言うコードを動かすと，

```javascript
let x = [1, 2, 3];
((y) => {
  y = [4, 5];
})(x);
console.log(x);
```

`y` に `[4, 5]` を代入しているので，
この
`console.log(x);` では，
`[4, 5]` を出力する．．．

...ことはなく，
`[1, 2, 3]`
が出力される．

参照呼びだったら `[4, 5]` が出力されるはずなので（下記），
どうやら値呼びらしい！

# 無理やり参照呼びを再現する

参照呼びだったら，さっきのコードは `[4, 5]` が出力される．

参照呼びのキモは，
「関数に，
渡したい値 **の参照** を渡す」と言うこと．

値呼びは，
「関数に，渡したい値を（複製して）そのまま渡す」．

そんな値呼びでも，
`{ ref: <value> }`
みたいなオブジェクトで wrap してあげて，
変数を使うときは必ず `.ref` をつけてやれば，
参照呼びの挙動を再現できる．

さっきのコードを無理やり参照呼び風にすると，
こんな感じになる．

```javascript
let x = { ref: [1, 2, 3] };
((y) => {
  y.ref = [4, 5];
})(x);
console.log(x.ref); // [4, 5]
```

この，
`console.log(x.ref);` では，
`[4, 5]`
が出力される．

このプログラムだと，

```javascript
})(x);
```

で，「`[1, 2, 3]` への参照」を直接渡さずに，
オブジェクトで wrap してやって，
「渡したい値への参照」，
今回だと，「`[1, 2, 3]` への参照 **への参照**」 を渡せるようにしている．

そうすると，最終的には

```javascript
y.ref = [4, 5];
```

で `x.ref` に束縛された参照も，
`[4, 5]` と言うオブジェクトを指すものに更新される．

# あってるかな？

間違ってそうだったら教えてください（ちょっと眠いのでヤバい．眠くなくてもヤバいかも）．

# 参考文献

何も見てない．．．

[^1]: もちろん Haskell とか言う言語もある．あと cpp も参照呼びできる（結構良くする？）
